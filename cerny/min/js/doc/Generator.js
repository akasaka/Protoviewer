// (c) 2006-2008 Robert Cerny
CERNY.require("CERNY.js.doc.Generator","CERNY.js.String","CERNY.js.Array","CERNY.util");(function(){var check=CERNY.check;var getNameFromFqName=CERNY.util.getNameFromFqName;var method=CERNY.method;var pre=CERNY.pre;var signature=CERNY.signature;var PRIVATE_COMMENT_START="/"+"*";var PUBLIC_COMMENT_START=PRIVATE_COMMENT_START+"*";var NEWLINE_DOS="\r\n";var NEWLINE_UNIX="\n";CERNY.js.doc.Generator=Generator;var logger=CERNY.Logger("CERNY.js.doc.Generator");CERNY.js.doc.Generator.prototype.logger=logger;function Generator(source){this.source=source;var t=this;this.signatures=new Cache(function(name){return t.extractSignature(name);});this.methods=new Cache(function(name){return t.extractMethod(name);});this.signatureDocumentations=new Cache(function(name){return t.extractSignatureDocumentation(name);});this.functionComments=new Cache(function(name){return t.extractFunctionComment(name);});this.fqName=this.extractFqName();return this;};function create(){var doc={},attr,value,matches,aspect;this.docPattern={author:{regexp:new RegExp("author.*: +(.*)","gmi")},creationDate:{regexp:new RegExp("created.*:\s*(.+)","gmi")},modificationDate:{regexp:new RegExp("last change.*:\s*(.+)","gmi")},documentation:{regexp:new RegExp("description:([\\w\\W]*?) \\* [a-zA-Z]","mi")}};for(attr in this.docPattern){logger.debug("attr: "+attr);if(this.docPattern.hasOwnProperty(attr)){aspect=this.docPattern[attr];matches=aspect.regexp.exec(this.source);logger.debug("matches: "+matches);if(matches){value=matches[1];logger.debug("value: "+value);doc[attr]=value;}}}
doc.fqName=this.fqName;doc.name=getNameFromFqName(doc.fqName);doc.history=this.extractHistory();doc.uses=this.extractUses();doc.documentation=this.extractDocumentation();this.fqName=doc.fqName;doc.functions=this.extractFunctions();return doc;};signature(create,"object","string");method(Generator.prototype,"create",create);function extractFqName(){var match=this.source.match(/require\(\u0022(.*?)\u0022/);if(match===null){throw new Error("Could not extract fully qualified name of script.");}
return match[1];}
signature(extractFqName,"string");method(Generator.prototype,"extractFqName",extractFqName);function extractDocumentation(){var docString=this.source.match(new RegExp("description:([\\w\\W]*?) \\* [a-zA-Z]","mi"));if(!docString){throw new Error("No documentation for script.");}
docString=docString[1];var documentation=[];docString=docString.replace(new RegExp("/\\*","g"),"");docString=docString.replace(new RegExp(" \\*   ","g"),"");documentation=docString.split(new RegExp("\\*$","m"));documentation=documentation.map(function(doc){return cleanMultilineDoc(doc);});if(documentation[0]==""){documentation.shift();}
documentation.pop();return documentation;}
signature(extractDocumentation,Array);method(Generator.prototype,"extractDocumentation",extractDocumentation);function extractFunctions(){var functions=this.discoverPublicFunctions().sort();var t=this;return functions.map(function(functionName){return t.extractFunctionDocumentation(functionName);});}
signature(extractFunctions,Array);method(Generator.prototype,"extractFunctions",extractFunctions);function extractHistory(){var history=[];try{var historyString=this.source.split("History:")[1].split("*/")[0];matches=historyString.match(new RegExp("([0-9]{4}-[0-9]{2}-[0-9]{2} .+)","gmi"));if(matches){matches.map(function(match){var segments=match.match(new RegExp("([0-9]{4}-[0-9]{2}-[0-9]{2}) (.*)"));var date=segments[1];var entry=segments[2].trim();history.push({date:date,entry:entry});});}}catch(e){logger.warn("History was not extracted without error.");}
return history;}
signature(extractHistory,Array);method(Generator.prototype,"extractHistory",extractHistory);function extractUses(){var uses=[];var matches=this.source.match(new RegExp("^((CERNY\.)?require[^\\)]*)\\)","gmi"));if(matches){var usesString=matches[0];usesString=usesString.replace(new RegExp("\\s+","gm"),"");var segments=usesString.split(new RegExp(","));segments.shift();uses=segments.map(function(segment){return segment.replace(new RegExp("\"","g"),"").replace(")","");});}
return uses;}
signature(extractUses,Array);method(Generator.prototype,"extractUses",extractUses);function discoverPublicFunctions(){var functions=[];var matches=this.source.match(/function \w+\(/gm);if(matches){functions=matches.map(function(match){return match.replace("function ","").replace("(","");});}
matches=this.source.match(/[\w.]+\ = function\(/gm);if(matches){functions.append(matches.map(function(match){return match.replace(" = function(","");}));}
var t=this;functions=functions.filter(function(f){return t.isPublic(f);});return functions;}
signature(discoverPublicFunctions,Array);method(Generator.prototype,"discoverPublicFunctions",discoverPublicFunctions);function isPublic(name){if(this.functionComments.get(name)){return true;}
return false;}
signature(isPublic,"boolean","string");method(Generator.prototype,"isPublic",isPublic);function extractFunctionDocumentation(name){var doc={};if(name.match(/\./)){doc.fqName=name;doc.name=getNameFromFqName(name);}else{doc.fqName=this.fqName+"."+name;doc.name=name;}
doc.documentation=this.extractFunctionDescription(name);doc.parameters=[];var i=0;var paramDoc;do{paramDoc=this.extractParameterDocumentation(name,i);if(paramDoc){doc.parameters.push(paramDoc);i++;}}while(paramDoc);var returnValueDoc=this.extractReturnValueDocumentation(name);if(returnValueDoc){doc.returnValue=returnValueDoc.documentation;doc.returnType=returnValueDoc.type;}
return doc;}
signature(extractFunctionDocumentation,"object","string");pre(extractFunctionDocumentation,function(){check(isNonEmptyString(this.fqName),"fqName must be a non empty string.");});method(Generator.prototype,"extractFunctionDocumentation",extractFunctionDocumentation);function extractFunctionDescription(functionName){var comment=this.functionComments.get(functionName);var documentation=splitCommentIntoParagraphs(comment);if(documentation.length==0){throw new Error("Function description not found for: "+functionName);}
documentation.shift();var lastOne=documentation.pop();if(lastOne.match(" - ")===null){documentation.push(lastOne);}
documentation=documentation.map(function(doc){return cleanMultilineDoc(doc).trim();});documentation=documentation.filter(isNonEmptyString);return documentation;}
signature(extractFunctionDescription,Array,"string");pre(extractFunctionDescription,function(functionName){check(this.isPublic(functionName),"function must be public");});method(Generator.prototype,"extractFunctionDescription",extractFunctionDescription);function extractParameterDocumentation(functionName,position){var documentation=this.signatureDocumentations.get(functionName);if(!documentation){return;}
var positionOfLastParameter=documentation.length-1;if(documentation.returnValue===true){positionOfLastParameter-=1;}
if(position>positionOfLastParameter){return;}
var signature=this.signatures.get(functionName);if(!signature){throw new Error("No signature present for: "+functionName);}
var doc={};doc.name=documentation[position].name;doc.documentation=documentation[position].documentation;doc.type=signature[position+1];return doc;}
signature(extractParameterDocumentation,"object","string","number");pre(extractParameterDocumentation,function(functionName,position){check(position>=0,"Position must be positive");});method(Generator.prototype,"extractParameterDocumentation",extractParameterDocumentation);function extractReturnValueDocumentation(functionName){var documentation=this.signatureDocumentations.get(functionName);if(!documentation){return;}
var signature=this.signatures.get(functionName);var doc={};if(documentation[documentation.length-1].name=="return"){doc.documentation=documentation[documentation.length-1].documentation;doc.type=signature[0];return doc;}}
signature(extractReturnValueDocumentation,"undefined,object","string");method(Generator.prototype,"extractReturnValueDocumentation",extractReturnValueDocumentation);function extractSignature(functionName){var signature;var signatureRegexp="(CERNY\\.)?signature."+functionName+",.*";signatureMatch=this.source.match(new RegExp(signatureRegexp,"gmi"));if(signatureMatch){signatureLine=signatureMatch[0];var typeMatches=signatureLine.match(new RegExp(",[^,]+","g"));signature=[];var inArray=false;var compoundTypeName="";typeMatches.map(function(typeMatch){var typeName=typeMatch.replace(/[^A-Za-z.]/g,"");if(typeMatch.indexOf("[")>=0){inArray=true;}
if(typeMatch.indexOf("]")>=0){inArray=false;compoundTypeName+=","+typeName;typeName=compoundTypeName.slice(1);compoundTypeName="";}
if(inArray){compoundTypeName+=","+typeName;}else{signature.push(typeName);}});}
return signature;}
signature(extractSignature,["undefined",Array],"string");method(Generator.prototype,"extractSignature",extractSignature);function extractMethod(functionName){var method;var methodRegexp="(CERNY\\.)?method\\(.*"+functionName+"\\)";methodMatch=this.source.match(new RegExp(methodRegexp,"gmi"));if(methodMatch){methodLine=methodMatch[0];methodLine=methodLine.split("(")[1];var params=methodLine.split(",");method={object:params[0],name:params[1].replace(/\"/g,"").trim()}}
return method;}
signature(extractMethod,"object","string");method(Generator.prototype,"extractMethod",extractMethod);function extractSignatureDocumentation(functionName){var doc=[];var comment=this.functionComments.get(functionName);var paragraphs=splitCommentIntoParagraphs(comment);var signatureDoc=paragraphs[paragraphs.length-1];var matches=signatureDoc.match(/ - /gm);if(matches===null){return;}
var expected=matches.length;var lines=signatureDoc.split(NEWLINE_DOS);if(lines.length==1&&expected>1){lines=signatureDoc.split(NEWLINE_UNIX);}
var next={};lines.map(function(line){if(line.match(new RegExp(" - "))){if(next.name){doc.push(next);next={};}
var parts=line.split(" - ");next.name=cleanMultilineDoc(parts[0]);next.documentation=cleanMultilineDoc(parts[1]);}else{if(line.match(/\w/)){next.documentation+=" "+cleanMultilineDoc(line);}}});doc.push(next);if(next.name=="return"){doc.returnValue=true;}
return doc;}
signature(extractSignatureDocumentation,["undefined",Array],"string");method(Generator.prototype,"extractSignatureDocumentation",extractSignatureDocumentation);function extractFunctionComment(functionName){var sourceSplit=this.source.split(new RegExp("function "+functionName+"\\("));if(sourceSplit.length!=2){sourceSplit=this.source.split(new RegExp(functionName+" = function"));if(sourceSplit.length!=2){throw new Error("Function definition not found for: "+functionName);}}
var before=sourceSplit[0];var comments=before.split(PUBLIC_COMMENT_START);var comment=PUBLIC_COMMENT_START+comments.pop();if(isPublicComment(comment)){comment=comment.replace(/\*\/[^°]*/m,"*/");return comment;}}
signature(extractFunctionComment,["undefined",String],"string");method(Generator.prototype,"extractFunctionComment",extractFunctionComment);function isPublicComment(str){if(str.match(new RegExp(NEWLINE_DOS+NEWLINE_DOS))){return false;}
if(str.match(new RegExp(NEWLINE_UNIX+NEWLINE_UNIX))){return false;}
if(str.match(/function \w+\(/)){return false;}
return true;}
signature(isPublicComment,"boolean","string");function cleanMultilineDoc(doc){return doc.replace(/\r?\n/g," ").replace(/ \* /g," ").replace(/ +/g," ").replace(/^ /,"").replace(/ $/,"").replace(/\*\//,"");}
function splitCommentIntoParagraphs(comment){var paragraphs=comment.split("*\r\n");if(paragraphs.length<2){paragraphs=comment.split("*\n");}
return paragraphs;}
signature(splitCommentIntoParagraphs,Array,"string");function Cache(retrieveFunction){this.store={};this.retrieveFunction=retrieveFunction;}
Cache.prototype.logger=CERNY.Logger("CERNY.js.doc.Generator.Cache");function get(name){if(!this.store[name]){var result=this.retrieveFunction(name);this.store[name]=result;}
return this.store[name];}
method(Cache.prototype,"get",get);})();